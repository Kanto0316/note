<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bloc-note collaboratif</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background-color: #2c3e50;
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
    }
    main {
      flex: 1;
      padding: 1rem;
    }
    #nouveau-note {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    #texte {
      flex: 1;
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
    }
    #fileInput {
      padding: 0.3rem;
    }
    #btnAjouter {
      background-color: #27ae60;
      color: #fff;
      border: none;
      padding: 0 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
    #recherche {
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #liste-notes {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 0.5rem;
      min-height: 2rem;
    }
    .note {
      margin-bottom: 0.75rem;
      padding-bottom: 2rem;
      border-bottom: 2px solid #27ae60;
      position: relative;
      word-break: break-word;
    }
    .note img {
      max-width: 100%;
      margin-top: 0.5rem;
    }
    .date-modif {
      position: absolute;
      right: 0.5rem;
      bottom: 0.25rem;
      font-size: 0.75rem;
      color: #555;
    }
    .highlight { background: yellow; }
  </style>
</head>
<body>
  <header>Bloc-note collaboratif</header>
  <main>
    <div id="nouveau-note">
      <textarea id="texte" placeholder="Écrivez ici…"></textarea>
      <input type="file" id="fileInput" accept="image/*" />
      <button id="btnAjouter">Ajouter</button>
    </div>
    <input type="text" id="recherche" placeholder="Recherche rapide…" />
    <div id="liste-notes"></div>
  </main>
  <footer style="text-align:center;padding:0.5rem;background:#ecf0f1;font-size:0.9rem;color:#666;">
    Les notes sont stockées en temps réel dans Firestore.
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // ⚠️ Remplacez le contenu ci-dessous par VOTRE configuration Firebase depuis la console
    const firebaseConfig = {
      apiKey: "VOTRE_API_KEY",
      authDomain: "VOTRE_PROJECT_ID.firebaseapp.com",
      projectId: "VOTRE_PROJECT_ID",
      storageBucket: "VOTRE_PROJECT_ID.appspot.com",
      messagingSenderId: "VOTRE_MESSAGING_SENDER_ID",
      appId: "VOTRE_APP_ID"
    };

    // ⚠️ Ajoutez 'https://kanto0316.github.io' (ou votre domaine) dans Authorized Domains
    //    dans la section Authentication > Sign-in method de Firebase Console.

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const notesCol = collection(db, "notes");

    const texte = document.getElementById("texte");
    const fileInput = document.getElementById("fileInput");
    const btnAjouter = document.getElementById("btnAjouter");
    const recherche = document.getElementById("recherche");
    const listeNotes = document.getElementById("liste-notes");

    let notes = [];

    function formaterDate(ts) {
      return ts?.toDate().toLocaleString("fr-FR", { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) || "";
    }

    function render() {
      const fil = recherche.value.trim().toLowerCase();
      listeNotes.innerHTML = "";
      notes.forEach(n => {
        if (fil && !n.contenu.toLowerCase().includes(fil)) return;
        const div = document.createElement("div");
        div.className = "note";
        // contenu
        const p = document.createElement("p");
        if (fil) {
          const regex = new RegExp(`(${fil.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,"gi");
          p.innerHTML = n.contenu.replace(regex, `<span class="highlight">$1</span>`);
        } else {
          p.textContent = n.contenu;
        }
        div.appendChild(p);
        // image
        if (n.imageBase64) {
          const img = document.createElement("img");
          img.src = n.imageBase64;
          div.appendChild(img);
        }
        // date
        const span = document.createElement("div");
        span.className = "date-modif";
        span.textContent = formaterDate(n.dateModification);
        div.appendChild(span);

        listeNotes.appendChild(div);
      });
    }

    onSnapshot(
      query(notesCol, orderBy("dateModification", "desc")),
      snap => {
        notes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        render();
      },
      err => console.error(err)
    );

    btnAjouter.addEventListener("click", () => {
      const txt = texte.value.trim();
      if (!txt) return alert("Écrivez du texte !");
      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => addDoc(notesCol, { contenu: txt, imageBase64: e.target.result, dateModification: serverTimestamp() });
        reader.readAsDataURL(file);
      } else {
        addDoc(notesCol, { contenu: txt, dateModification: serverTimestamp() });
      }
      texte.value = "";
      fileInput.value = "";
    });
  </script>
</body>
</html>
