<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bloc-note collaboratif</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f7f7f7; display:flex; flex-direction:column; min-height:100vh; }
    header { background:#2c3e50; color:#fff; padding:1rem; text-align:center; font-size:1.5rem; cursor:pointer;}
    main { flex:1; padding:1rem; opacity:0.5; pointer-events:none;}
    main.active { opacity:1; pointer-events:auto;}
    #nouveau-note { display:flex; gap:0.5rem; margin-bottom:1rem;}
    #texte { flex:1; padding:0.5rem; border:1px solid #ccc; border-radius:4px; resize:vertical;}
    #imgNote { padding:0.5rem;}
    #btnAjouter { background:#27ae60; color:#fff; border:none; padding:0.5rem 1rem; border-radius:4px; cursor:pointer;}
    .search-container { margin-bottom:0.75rem;}
    #recherche { width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px;}
    #etatRecherche { font-size:0.9rem; margin-bottom:0.75rem; min-height:1.2rem;}
    #liste-notes { background:#fff; border:1px solid #ddd; border-radius:4px; padding:0.5rem;}
    .note { position:relative; border-bottom:2px solid #27ae60; padding:1rem; margin-bottom:1rem; white-space:pre-wrap; word-break:break-word;}
    .note:last-child { border-bottom:none; margin-bottom:0;}
    .supprimer { position:absolute; top:0.5rem; right:0.5rem; background:none; border:none; color:#c0392b; font-size:1.2rem; cursor:pointer;}
    .note img { max-width:100%; margin-top:0.5rem; border-radius:4px;}
    .auteur, .date-modif { font-size:0.8rem; color:#555;}
    .date-modif { position:absolute; bottom:0.5rem; right:0.5rem;}
    .auteur { position:absolute; bottom:0.5rem; left:0.5rem;}
    .highlight { background:yellow;}
    .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); display:none; justify-content:center; align-items:center; z-index:10;}
    .modal { background:#fff; padding:1rem; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.3); max-width:90%; width:300px; text-align:center;}
    .modal h2 { margin-top:0;}
    .buttons { display:flex; justify-content:space-around; margin-top:1rem;}
    .btn { padding:0.4rem 0.8rem; border:none; border-radius:4px; cursor:pointer; color:#fff;}
    .ok { background:#2980b9;}
    .cancel { background:#7f8c8d;}
    .yes { background:#c0392b;}
    .no { background:#7f8c8d;}
  </style>
</head>
<body>
  <header id="headerTitle">Bloc-note collaboratif</header>
  <main id="mainContent">
    <div id="nouveau-note">
      <textarea id="texte" rows="2" placeholder="Écrivez ici…"></textarea>
      <input type="file" id="imgNote" accept="image/*"/>
      <button id="btnAjouter">Ajouter</button>
    </div>
    <div class="search-container">
      <input type="text" id="recherche" placeholder="Recherche rapide…"/>
    </div>
    <div id="etatRecherche"></div>
    <div id="liste-notes"></div>
  </main>
  <footer>Les notes sont stockées en temps réel dans Firestore.</footer>

  <div id="modalNameOverlay" class="modal-overlay">
    <div class="modal"><h2>Entrer votre nom</h2>
      <input type="text" id="inputUserName" maxlength="20" placeholder="Votre nom…"/>
      <div class="buttons"><button id="okName" class="btn ok">OK</button></div>
    </div>
  </div>
  <div id="modalEditOverlay" class="modal-overlay">
    <div class="modal"><h2>Modifier votre nom ?</h2>
      <input type="text" id="inputEditUserName" maxlength="20"/>
      <div class="buttons">
        <button id="okEditName" class="btn ok">OK</button>
        <button id="cancelEditName" class="btn cancel">Annuler</button>
      </div>
    </div>
  </div>
  <div id="modalOverlay" class="modal-overlay">
    <div class="modal"><h2>Voulez-vous supprimer cet élément ?</h2>
      <div class="buttons">
        <button id="confirmDelete" class="btn yes">Oui</button>
        <button id="cancelDelete" class="btn no">Non</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics.js";
    import {
      getFirestore, collection, addDoc, deleteDoc, doc,
      onSnapshot, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    const firebaseConfig = { /* vos clés */ };
    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const db = getFirestore(app);

    const notesCol = collection(db,"notes");
    const header = document.getElementById("headerTitle");
    const main = document.getElementById("mainContent");
    const texte = document.getElementById("texte");
    const imgNote = document.getElementById("imgNote");
    const btnAjouter = document.getElementById("btnAjouter");
    const liste = document.getElementById("liste-notes");
    const recherche = document.getElementById("recherche");
    const etatRecherche = document.getElementById("etatRecherche");
    const modalName = document.getElementById("modalNameOverlay");
    const inputUserName = document.getElementById("inputUserName");
    const okName = document.getElementById("okName");
    const modalEdit = document.getElementById("modalEditOverlay");
    const inputEditUserName = document.getElementById("inputEditUserName");
    const okEditName = document.getElementById("okEditName");
    const cancelEditName = document.getElementById("cancelEditName");
    const modalDel = document.getElementById("modalOverlay");
    const confirmDelete = document.getElementById("confirmDelete");
    const cancelDelete = document.getElementById("cancelDelete");

    let userName="", imageData=null, deleteId=null;

    function showNameModal(){ modalName.style.display="flex"; }
    okName.onclick=()=>{
      let n=inputUserName.value.trim()||"User"+Math.floor(Math.random()*100);
      userName=n; localStorage.setItem("userName",n);
      header.textContent=n; modalName.style.display="none";
      main.classList.add("active");
    };
    header.onclick=()=>{
      inputEditUserName.value=userName; modalEdit.style.display="flex";
    };
    okEditName.onclick=()=>{
      let newN=inputEditUserName.value.trim()||userName;
      userName=newN; localStorage.setItem("userName",newN);
      header.textContent=newN; modalEdit.style.display="none";
    };
    cancelEditName.onclick=()=>modalEdit.style.display="none";

    imgNote.onchange=e=>{
      const file=e.target.files[0];
      if(file){ const reader=new FileReader();
        reader.onload=()=>imageData=reader.result;
        reader.readAsDataURL(file);
      } else imageData=null;
    };

    btnAjouter.onclick=async()=>{
      const txt=texte.value.trim();
      if(!txt&&!imageData) return;
      await addDoc(notesCol,{ auteur:userName, contenu:txt, image:imageData||null,
        dateCreation:serverTimestamp(), dateModification:serverTimestamp() });
      texte.value=""; imgNote.value=""; imageData=null;
    };

    confirmDelete.onclick=async()=>{
      if(deleteId) await deleteDoc(doc(notesCol,deleteId));
      modalDel.style.display="none";
    };
    cancelDelete.onclick=()=>modalDel.style.display="none";

    onSnapshot(query(notesCol,orderBy("dateModification","desc")),snap=>{
      liste.innerHTML="";
      snap.docs.forEach(d=>{
        const note=d.data(), id=d.id;
        const div=document.createElement("div"); div.className="note";
        if(note.auteur===userName||userName==="Admin"){
          const b=document.createElement("button");
          b.className="supprimer"; b.textContent="×";
          b.onclick=()=>{deleteId=id; modalDel.style.display="flex";};
          div.appendChild(b);
        }
        if(note.contenu){ const p=document.createElement("p"); p.textContent=note.contenu; div.appendChild(p); }
        if(note.image){ const im=document.createElement("img"); im.src=note.image; div.appendChild(im); }
        const au=document.createElement("div"); au.className="auteur"; au.textContent=note.auteur; div.appendChild(au);
        let dateTxt="";
        if(note.dateModification){
          if(typeof note.dateModification.toDate==="function") dateTxt=note.dateModification.toDate().toLocaleString();
          else dateTxt=new Date(note.dateModification).toLocaleString();
        }
        const dt=document.createElement("div"); dt.className="date-modif"; dt.textContent=dateTxt; div.appendChild(dt);
        liste.appendChild(div);
      });
    });

    recherche.oninput=()=>{
      const term=recherche.value.trim().toLowerCase();
      etatRecherche.textContent=term?`Recherche : "${term}"`:"";
      document.querySelectorAll(".note").forEach(div=>{
        div.innerHTML=div.innerHTML.replace(/<span class="highlight">|<\/span>/g,"");
        if(term){
          const regex=new RegExp(term,"gi");
          div.innerHTML=div.innerHTML.replace(regex,m=>`<span class="highlight">${m}</span>`);
        }
      });
    };

    const saved=localStorage.getItem("userName");
    if(saved){userName=saved; header.textContent=saved; main.classList.add("active");}
    else showNameModal();
  </script>
</body>
</html>
